# 설계 문서

> **English Version**: See [../design.md](../design.md)

## 개요

이 설계 문서는 AI 어시스턴트 채팅 인터페이스에 대한 네 가지 중요한 개선사항의 기술 구현을 설명합니다: 날짜 인식, 내용 기반 업데이트, 사전 목록 새로고침, 세션 기반 보안 시행입니다. 이러한 개선사항은 AI의 시간 추론을 개선하고, 상호작용을 더 자연스럽게 만들며, 자동 피드백을 통해 더 나은 UX를 제공하고, 강력한 보안을 보장합니다.

## 주요 구성 요소

### 1. 날짜 인식 컨텍스트 주입
- KST 시간대의 현재 날짜 계산
- 모든 Gemini API 요청에 날짜 컨텍스트 추가
- 시스템 프롬프트에 날짜 인식 규칙 포함

### 2. 내용 기반 Todo 업데이트
- `findTodoByContent()` 메서드로 제목으로 todo 검색
- ID 기반 및 내용 기반 업데이트 모두 지원하도록 `updateTodo()` 개선
- `isCompleted` 부울 매개변수로 완료 상태 관리

### 3. 쓰기 작업 후 사전 목록 새로고침
- `createTodo()` 및 `updateTodo()`가 자동으로 새로고침된 목록 반환
- AI가 성공 메시지와 함께 목록을 표시하도록 시스템 프롬프트 업데이트

### 4. 필수 세션 기반 보안
- 모든 함수 메서드가 세션 userSeq 사용
- 도구 정의에 userSeq 매개변수 없음
- TodoService 메서드가 userSeq로 필터링
- 업데이트 작업에 소유권 확인 추가

### 5. 완전한 감사 추적
- ChatController에서 AssistanceService로 userId 전달
- 생성 시 reg_* 및 upd_* 컬럼 모두 채우기
- 업데이트 시 upd_* 컬럼만 업데이트

### 6. 프론트엔드 자동 새로고침
- Zustand chatStore에 새로고침 트리거 추가
- TodoContainer가 새로고침 이벤트 수신
- 성공적인 AI 응답 시 새로고침 트리거

### 7. 자동 환영 메시지
- chatStore에 `addWelcomeMessage()` 액션 추가
- 첫 채팅 열기 시 환영 메시지 주입
- 사용 예제가 포함된 HTML 포맷 메시지
- sessionStorage에 지속성 유지

## 배포 계획

### 1단계: 날짜 인식 (낮은 위험)
- 시스템 프롬프트에 날짜 컨텍스트 추가
- 다양한 날짜 쿼리로 테스트
- 잘못된 날짜 해석 모니터링

### 2단계: 내용 기반 업데이트 (중간 위험)
- findTodoByContent 메서드 구현
- updateTodo 도구 정의 업데이트
- 다양한 내용 쿼리로 테스트
- 모호한 일치 모니터링

### 3단계: 사전 새로고침 (낮은 위험)
- 쓰기 작업 응답에 refreshedList 추가
- 새로고침 지침으로 시스템 프롬프트 업데이트
- 응답 포맷 테스트
- 응답 시간 모니터링

### 4단계: 보안 감사 (중요)
- userSeq 사용에 대한 모든 코드 경로 검토
- 도구 정의에 userSeq 매개변수가 없는지 확인
- 교차 사용자 액세스 시도 테스트
- 보안 침투 테스트

### 5단계: 환영 메시지 (낮은 위험)
- chatStore에 addWelcomeMessage 액션 구현
- 채팅 모달 열기 이벤트와 통합
- 메시지 지속성 및 억제 로직 테스트
- 예제에 대한 사용자 참여도 모니터링

## 보안 고려사항

- 모든 작업에 세션 userSeq 사용
- AI가 userSeq를 지정할 수 없음
- 데이터 유출 방지를 위한 데이터베이스 쿼리 필터링
- 인젝션 공격 방지를 위한 입력 새니타이제이션
- 환영 메시지 HTML은 DOMPurify로 새니타이즈

## 성능 고려사항

- 날짜 계산은 경량 (외부 호출 없음)
- 내용 검색은 사용자 자신의 todo로 제한
- 사전 새로고침은 ±7일로 제한
- 환영 메시지는 세션당 한 번만 추가

자세한 기술 세부사항은 영문 설계 문서를 참조하세요.
