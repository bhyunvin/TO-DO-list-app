# 요구사항 문서

> **English Version**: See [../requirements.md](../requirements.md)

## 소개

이 명세서는 보안, 사용자 경험 및 AI 지능을 개선하기 위한 기존 AI 어시스턴트 채팅 인터페이스의 개선사항을 정의합니다. 개선사항은 네 가지 중요한 영역을 다룹니다: 정확한 시간 추론을 위한 날짜 인식, 자연스러운 상호작용을 위한 내용 기반 작업 업데이트, 개선된 UX를 위한 사전 목록 새로고침, 필수 세션 기반 보안 시행입니다.

## 용어집

- **AI_Assistant_Service**: Google Gemini API와의 통신을 처리하는 백엔드 NestJS 서비스
- **System_Prompt**: AI 동작 및 기능을 정의하는 지시 텍스트
- **Function_Calling**: AI가 미리 정의된 함수를 호출할 수 있게 하는 Gemini API 기능
- **Todo_Service**: todo 데이터 액세스 메서드를 제공하는 백엔드 서비스
- **User_Session**: userSeq 및 사용자 정보를 포함하는 인증된 세션
- **KST**: 한국 표준시 (UTC+9)
- **Content_Based_Update**: ID 대신 제목/내용으로 todo 식별
- **Proactive_Refresh**: 쓰기 작업 후 업데이트된 데이터 자동 표시

## 요구사항

### 요구사항 1: 날짜 인식 AI 컨텍스트

**사용자 스토리:** 사용자로서, AI가 "오늘", "내일" 또는 "11월 14일"과 같은 모호한 날짜를 올바르게 해석하여 정확한 연도와 날짜로 todo를 생성하고 조회할 수 있기를 원합니다.

#### 수락 기준

1. AI_Assistant_Service가 사용자 요청을 처리할 때, 시스템은 YYYY-MM-DD 형식으로 포맷된 KST 시간대의 현재 서버 날짜를 제공해야 합니다
2. System_Prompt는 Gemini API에 대한 모든 요청에 현재 날짜 컨텍스트를 포함해야 합니다
3. 사용자가 연도 없이 모호한 날짜를 제공하면, AI_Assistant_Service는 현재 날짜 컨텍스트를 기반으로 올바른 전체 날짜로 해결해야 합니다
4. AI_Assistant_Service는 날짜 계산을 위해 KST로 변환된 서버의 시스템 시간을 사용해야 합니다
5. "오늘" 또는 "내일"과 같은 상대 날짜로 todo를 생성하거나 조회할 때, AI_Assistant_Service는 현재 날짜를 기반으로 YYYY-MM-DD 값을 올바르게 계산해야 합니다

### 요구사항 2: 내용 기반 Todo 업데이트

**사용자 스토리:** 사용자로서, todo ID를 알거나 지정할 필요 없이 제목이나 내용을 참조하여 todo를 업데이트할 수 있기를 원합니다 (예: "'우유 사기' 작업 업데이트").

#### 수락 기준

1. 사용자가 내용으로 todo 업데이트를 요청하면, AI_Assistant_Service는 제공된 내용 텍스트를 사용하여 일치하는 todo를 검색해야 합니다
2. 정확히 하나의 todo가 내용과 일치하면, AI_Assistant_Service는 해당 todo의 todoSeq를 사용하여 업데이트 작업을 진행해야 합니다
3. 여러 todo가 내용과 일치하면, AI_Assistant_Service는 추가 컨텍스트(날짜 또는 기타 세부사항)를 제공하여 어떤 todo인지 명확히 하도록 사용자에게 요청해야 합니다
4. 내용과 일치하는 todo가 없으면, AI_Assistant_Service는 일치하는 todo를 찾을 수 없다고 사용자에게 알려야 합니다
5. updateTodo 함수는 todoSeq 기반 업데이트(기존)와 내용 기반 업데이트(신규) 모두를 지원해야 합니다
6. 완료 상태를 업데이트할 때, updateTodo 함수는 completeDtm 타임스탬프 대신 isCompleted 부울 매개변수를 받아야 합니다
7. isCompleted가 true이면, 시스템은 completeDtm을 현재 서버 타임스탬프로 설정해야 합니다
8. isCompleted가 false이면, 시스템은 completeDtm을 NULL로 설정해야 합니다
9. isCompleted가 제공되지 않으면, 시스템은 completeDtm 값을 수정하지 않아야 합니다

### 요구사항 3: 쓰기 작업 후 사전 목록 새로고침

**사용자 스토리:** 사용자로서, 작업을 생성하거나 수정한 후 두 번째 요청을 하지 않고도 업데이트된 todo 목록을 자동으로 볼 수 있기를 원합니다.

#### 수락 기준

1. createTodo 작업이 성공하면, AI_Assistant_Service는 관련 날짜 범위에 대한 업데이트된 todo 목록을 자동으로 가져와 표시해야 합니다
2. updateTodo 작업이 성공하면, AI_Assistant_Service는 관련 날짜 범위에 대한 업데이트된 todo 목록을 자동으로 가져와 표시해야 합니다
3. System_Prompt는 AI에게 새로고침된 todo 목록을 표시하기 위해 FORMATTING_RULES를 사용하도록 지시해야 합니다
4. AI_Assistant_Service는 성공 확인 메시지와 포맷된 todo 목록을 모두 응답에 포함해야 합니다
5. 새로고침된 todo 목록은 작업과 관련된 todo를 표시해야 합니다 (예: "오늘" 생성된 작업의 경우 오늘 목록)

### 요구사항 4: 필수 세션 기반 보안

**사용자 스토리:** 시스템 관리자로서, 모든 todo 작업이 인증된 사용자의 세션에 안전하게 범위가 지정되어 사용자가 다른 사용자의 데이터에 액세스하거나 수정할 수 없기를 원합니다.

#### 수락 기준

1. AI_Assistant_Service는 모든 요청에 대해 인증된 사용자 세션에서 userSeq를 받아야 합니다
2. getTodos 함수는 내부적으로 세션 userSeq를 사용해야 하며 AI가 제어할 수 있는 매개변수로 userSeq를 받아서는 안 됩니다
3. createTodo 함수는 내부적으로 세션 userSeq를 사용해야 하며 AI가 제어할 수 있는 매개변수로 userSeq를 받아서는 안 됩니다
4. updateTodo 함수는 내부적으로 세션 userSeq를 사용해야 하며 AI가 제어할 수 있는 매개변수로 userSeq를 받아서는 안 됩니다
5. Todo_Service 메서드는 작업을 수행하기 전에 요청된 todo가 세션 userSeq에 속하는지 확인해야 합니다
6. todo가 세션 userSeq에 속하지 않으면, Todo_Service는 다른 사용자의 데이터를 노출하지 않고 오류 또는 빈 결과를 반환해야 합니다
7. 함수 도구 정의는 Gemini가 지정할 수 있는 매개변수로 userSeq를 포함해서는 안 됩니다

### 요구사항 5: 데이터베이스 작업에 대한 완전한 감사 추적

**사용자 스토리:** 시스템 관리자로서, 모든 todo 생성 및 업데이트 작업이 완전한 감사 컬럼(reg_id, reg_ip, reg_dtm, upd_id, upd_ip, upd_dtm)을 채워 규정 준수 및 디버깅 목적으로 각 레코드를 생성하고 수정한 사람을 추적할 수 있기를 원합니다.

#### 수락 기준

1. ChatController는 세션에서 인증된 사용자의 userId를 AI_Assistant_Service에 전달해야 합니다
2. AI_Assistant_Service는 userId 매개변수를 createTodo 및 updateTodo 함수에 전달해야 합니다
3. 새 todo를 생성할 때, 시스템은 reg_id를 세션 userId로 채워야 합니다
4. 새 todo를 생성할 때, 시스템은 reg_ip를 클라이언트 IP 주소로 채워야 합니다
5. 새 todo를 생성할 때, 시스템은 reg_dtm을 현재 서버 타임스탬프로 채워야 합니다
6. 새 todo를 생성할 때, 시스템은 upd_id도 세션 userId로 채워야 합니다
7. 새 todo를 생성할 때, 시스템은 upd_ip도 클라이언트 IP 주소로 채워야 합니다
8. 새 todo를 생성할 때, 시스템은 upd_dtm도 현재 서버 타임스탬프로 채워야 합니다
9. 기존 todo를 업데이트할 때, 시스템은 upd_id를 세션 userId로 채워야 합니다
10. 기존 todo를 업데이트할 때, 시스템은 upd_ip를 클라이언트 IP 주소로 채워야 합니다
11. 기존 todo를 업데이트할 때, 시스템은 upd_dtm을 현재 서버 타임스탬프로 채워야 합니다
12. setAuditColumn 유틸리티 함수는 생성 작업 시 reg_* 및 upd_* 컬럼을 모두 초기화해야 합니다
13. setAuditColumn 유틸리티 함수는 업데이트 작업 시 upd_* 컬럼만 업데이트해야 합니다

### 요구사항 6: AI 작업 후 프론트엔드 자동 새로고침

**사용자 스토리:** 사용자로서, AI 채팅을 통해 작업을 생성하거나 업데이트할 때 메인 todo 목록 UI가 자동으로 새로고침되어 페이지를 수동으로 새로고침하지 않고도 변경사항을 즉시 볼 수 있기를 원합니다.

#### 수락 기준

1. ChatModal이 AI 어시스턴트로부터 성공적인 API 응답을 받으면, 시스템은 새로고침 이벤트를 트리거해야 합니다
2. TodoListComponent는 새로고침 이벤트를 수신해야 합니다
3. TodoListComponent가 새로고침 이벤트를 받으면, 시스템은 데이터 가져오기 함수를 호출하여 todo 목록을 다시 로드해야 합니다
4. 새로고침 메커니즘은 기존 Zustand 상태 관리 아키텍처를 사용해야 합니다
5. 새로고침은 사용자 상호작용 없이 자동으로 발생해야 합니다
6. 새로고침은 todo 목록의 현재 선택된 날짜를 방해해서는 안 됩니다
7. 시스템은 일관성을 보장하기 위해 모든 성공적인 AI 채팅 응답에 대해 새로고침을 트리거해야 합니다

### 요구사항 7: 새 채팅 세션을 위한 자동 환영 메시지

**사용자 스토리:** 사용자로서, 새 채팅 세션을 시작할 때 사용 예제가 포함된 유용한 환영 메시지를 보고 AI 어시스턴트와 상호작용하는 방법을 이해할 수 있기를 원합니다.

#### 수락 기준

1. 사용자가 세션에서 처음으로 채팅 모달을 열면, 시스템은 첫 번째 메시지로 환영 메시지를 표시해야 합니다
2. 환영 메시지는 AI 어시스턴트에 대한 인사말과 소개를 포함해야 합니다
3. 환영 메시지는 todo 추가, 보기 및 업데이트에 대한 구체적인 사용 예제를 제공해야 합니다
4. 환영 메시지는 이모지, 제목 및 목록을 포함한 적절한 HTML 구조로 한국어로 포맷되어야 합니다
5. 환영 메시지는 일반 어시스턴트 메시지처럼 채팅 기록에 저장되어야 합니다
6. 환영 메시지는 동일 세션 내에서 페이지 새로고침 시에도 sessionStorage에 유지되어야 합니다
7. 사용자가 채팅 기록을 지우면, 시스템은 자동으로 환영 메시지를 재주입해야 합니다
8. 채팅 세션에 이전 상호작용의 메시지가 이미 포함되어 있으면 환영 메시지가 표시되어서는 안 됩니다

## 보안 고려사항

### 세션 시행
- 모든 todo 작업은 인증된 세션의 userSeq를 사용해야 합니다
- AI는 userSeq 매개변수를 지정하거나 재정의할 수 없습니다
- 데이터베이스 쿼리는 데이터 유출을 방지하기 위해 userSeq로 필터링해야 합니다

### 입력 검증
- 내용 기반 검색은 인젝션 공격을 방지하기 위해 사용자 입력을 새니타이즈해야 합니다
- 날짜 파싱은 잘못된 날짜를 방지하기 위해 형식과 범위를 검증해야 합니다
- 모든 사용자 입력은 데이터베이스 쿼리에 사용되기 전에 검증되어야 합니다

## 성능 고려사항

### 내용 기반 검색
- 내용 일치는 적절한 인덱싱을 사용하여 효율적인 데이터베이스 쿼리를 사용해야 합니다
- 퍼지 매칭은 성능 저하를 방지하기 위해 제한되어야 합니다
- 검색은 더 나은 사용자 경험을 위해 대소문자를 구분하지 않아야 합니다

### 사전 새로고침
- 자동 목록 새로고침은 관련 todo만 가져와야 합니다 (전체 데이터베이스가 아님)
- 새로고침을 위한 날짜 범위는 지능적이어야 합니다 (예: 작업 날짜로부터 ±7일)
- 응답 크기는 느린 API 응답을 방지하기 위해 합리적이어야 합니다
